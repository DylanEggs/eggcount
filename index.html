<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Egg Count (Shared)</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c5cff">

<style>
body{margin:0;font-family:system-ui;background:#0b1020;color:#eaf0ff;padding:20px}
.card{background:#121a35;padding:16px;border-radius:14px;margin-bottom:16px}
input,select{width:100%;padding:8px;margin-top:4px;margin-bottom:10px;border-radius:8px;border:1px solid #333;background:#0f1733;color:#fff}
button{padding:8px 12px;border-radius:8px;border:0;background:#7c5cff;color:#fff;cursor:pointer;margin-right:6px}
button.danger{background:#e11d48}
.kpi{margin-bottom:10px}
.small{font-size:12px;color:#9fb0d0}
</style>
</head>

<body>

<h2>Egg Count (Shared)</h2>

<div class="card">
<label>Date</label>
<input type="date" id="date">

<label>Collected by</label>
<select id="collector">
<option>Dylan</option>
<option>Oma</option>
<option>Ashley</option>
</select>

<label>Eggs collected</label>
<input type="number" id="eggs" min="0">

<label>Dozens sold</label>
<input type="number" id="soldDozens" min="0">

<label>18-packs sold</label>
<input type="number" id="sold18" min="0">

<button onclick="addEntry()">Add / Update Day</button>
<button class="danger" onclick="wipeAll()">Wipe All Data</button>
</div>

<div class="card">
<div class="kpi"><b>Total eggs (365 days):</b> <span id="eggs365">0</span></div>
<div class="kpi"><b>Projected per week:</b> <span id="week">0</span></div>
<div class="kpi"><b>Projected per month:</b> <span id="month">0</span></div>
<div class="kpi"><b>Projected per year:</b> <span id="year">0</span></div>
</div>

<div class="card">
<h3>Entries</h3>
<div id="list"></div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxL-mOn9qYXGNNUpvcyPqWJUI61PJdE92HR-A6nw0lMSd60WIQcckQsrQWte8euBXZM/exec";
const API_KEY="DylanEggsFamily-9482";

function todayISO(){return new Date().toISOString().slice(0,10)}
document.getElementById("date").value=todayISO()

async function api(action,data={}){
data.action=action
data.key=API_KEY
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify(data)})
return await res.json()
}

async function loadData(){
const res=await fetch(API_URL+"?action=getall&key="+API_KEY)
const json=await res.json()
if(!json.ok)return
render(json.data.entries)
}

async function addEntry(){
await api("upsertentry",{entry:{
dateISO:document.getElementById("date").value,
collector:document.getElementById("collector").value,
eggs:Number(document.getElementById("eggs").value||0),
soldDozens:Number(document.getElementById("soldDozens").value||0),
sold18:Number(document.getElementById("sold18").value||0)
}})
loadData()
}

async function wipeAll(){
const confirmText=prompt("Type WIPE to confirm deleting ALL shared data")
if(confirmText!=="WIPE")return
await api("wipeall",{confirm:"WIPE"})
loadData()
}

function render(entries){
let total=0
let html=""
entries.sort((a,b)=>b.dateISO.localeCompare(a.dateISO))
entries.forEach(e=>{
total+=e.eggs
html+=`<div>${e.dateISO} - ${e.collector} - ${e.eggs} eggs</div>`
})
document.getElementById("list").innerHTML=html

let days=Math.max(1,entries.length)
let avg=total/days
document.getElementById("eggs365").innerText=total
document.getElementById("week").innerText=Math.round(avg*7)
document.getElementById("month").innerText=Math.round(avg*30.4)
document.getElementById("year").innerText=Math.round(avg*365)
}

loadData()
setInterval(loadData,20000)
</script>

<script>
if("serviceWorker" in navigator){
navigator.serviceWorker.register("./sw.js")
}
</script>

</body>
</html>