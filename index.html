<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Egg Count (Shared)</title>
  <link rel="manifest" href="/eggcount/manifest.webmanifest">

  <style>
    :root{
      --bg:#0b1020; --card:#141b2f; --text:#eaf0ff; --muted:#9fb0d9;
      --accent:#7c5cff; --good:#2dd4bf; --bad:#fb7185; --border:rgba(255,255,255,.12);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 20% 0%, #18224a, var(--bg));color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:0 0 6px;font-size:28px}
    .sub{margin:0 0 14px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:13px;color:var(--muted)}
    .pill.ok{border-color:rgba(45,212,191,.45);color:var(--good)}
    .pill.err{border-color:rgba(251,113,133,.45);color:var(--bad)}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(20,27,47,.78);border:1px solid var(--border);border-radius:18px;padding:14px;backdrop-filter:blur(10px)}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    input,select{width:100%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:var(--text);outline:none;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    button{border:0;border-radius:14px;padding:11px 14px;font-size:16px;color:#fff;cursor:pointer}
    .primary{background:var(--accent)}
    .secondary{background:rgba(255,255,255,.12)}
    .danger{background:rgba(251,113,133,.85)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kpi{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
    .kpi .t{color:var(--muted);font-size:13px}
    .kpi .v{font-size:26px;margin-top:4px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left}
    th{color:var(--muted);font-weight:600;font-size:13px}
    .small{color:var(--muted);font-size:13px;line-height:1.35}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <h1>Egg Count (Shared)</h1>
        <p class="sub">Shared log for Dylan / Oma / Ashley. Rolling 365 with projections.</p>
      </div>
      <div class="pill" id="syncPill">Sync: —</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 6px">Daily entry</h2>
        <div class="small">Add or update today’s numbers. Delete mistakes below.</div>

        <div class="row">
          <div>
            <label>Date</label>
            <input type="date" id="dateISO">
          </div>
          <div>
            <label>Collected by</label>
            <select id="collector">
              <option>Dylan</option>
              <option>Oma</option>
              <option>Ashley</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Eggs collected</label>
            <input type="number" id="eggs" min="0" step="1" placeholder="0">
          </div>
          <div>
            <label>Dozen cartons sold</label>
            <input type="number" id="soldDozens" min="0" step="0.25" placeholder="0">
          </div>
          <div>
            <label>18-packs sold</label>
            <input type="number" id="sold18" min="0" step="1" placeholder="0">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Current hens</label>
            <input type="number" id="hens" min="0" step="1" placeholder="0">
          </div>
          <div>
            <label>Current roosters</label>
            <input type="number" id="roosters" min="0" step="1" placeholder="0">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Price per dozen ($)</label>
            <input type="number" id="priceDozen" min="0" step="0.01" placeholder="5.00">
          </div>
          <div>
            <label>Price per 18-pack ($)</label>
            <input type="number" id="price18" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="saveBtn">Add / Update Day</button>
          <button class="secondary" id="syncBtn">Sync now</button>
          <button class="danger" id="wipeBtn">Wipe all shared data</button>
        </div>

        <div class="small" id="status" style="margin-top:10px"></div>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

        <h3 style="margin:0 0 8px">Delete one entry</h3>
        <div class="row">
          <div style="grid-column:1/-1">
            <label>Select entry</label>
            <select id="deleteSelect"></select>
          </div>
        </div>
        <div class="btns">
          <button class="danger" id="deleteBtn">Delete selected</button>
        </div>

        <div class="small" style="margin-top:10px">
          Tip: open this in Safari and use <b>Share → Add to Home Screen</b>.
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px">Stats</h2>
        <div class="small" id="asOf">as of —</div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Total eggs (rolling 365)</div>
            <div class="v" id="eggs365">0</div>
          </div>
          <div class="kpi">
            <div class="t">Projected eggs / week</div>
            <div class="v" id="eggsWeek">0</div>
          </div>
          <div class="kpi">
            <div class="t">Projected eggs / month</div>
            <div class="v" id="eggsMonth">0</div>
          </div>
          <div class="kpi">
            <div class="t">Projected eggs / year</div>
            <div class="v" id="eggsYear">0</div>
          </div>
          <div class="kpi">
            <div class="t">Revenue (rolling 7 days)</div>
            <div class="v" id="rev7">$0.00</div>
          </div>
          <div class="kpi">
            <div class="t">Revenue (rolling 30 days)</div>
            <div class="v" id="rev30">$0.00</div>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

        <h3 style="margin:0 0 8px">Entries (newest first)</h3>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Collector</th><th>Eggs</th><th>Dozens</th><th>18</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="small mono" style="margin-top:12px">
      VERSION: 9002
    </div>
  </div>

<script>
/*** ✅ YOUR BACKEND HERE ***/
const API_URL = "https://script.google.com/macros/s/AKfycbxzmtRyFULnjQaHJXf7sxXGgGjVR06-xOKnH7khFCWEeFned8pj_aqioj0dGA3RM-sC/exec";
const API_KEY = "DylanEggsFamily-9482";

/*** helpers ***/
const $ = (id) => document.getElementById(id);
const fmtUSD = (n) => Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});
const clamp0 = (n) => Math.max(0, Number(n||0));
function isoToday(){
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d.getTime()-tz).toISOString().slice(0,10);
}
function parseISO(iso){
  const [y,m,dd] = iso.split("-").map(Number);
  return new Date(Date.UTC(y,m-1,dd));
}
function daysWindow(endISO, days){
  const end = parseISO(endISO);
  const start = new Date(end.getTime());
  start.setUTCDate(start.getUTCDate()-(days-1));
  return {start,end};
}
function inRange(d, start, end){
  const t=d.getTime();
  return t>=start.getTime() && t<=end.getTime();
}

/*** UI state ***/
let entries = [];
let settings = {hens:0,roosters:0,priceDozen:5,price18:0};

function setStatus(msg){ $("status").textContent = msg || ""; }
function setSync(kind, msg){
  const pill = $("syncPill");
  pill.className = "pill" + (kind ? " " + kind : "");
  pill.textContent = "Sync: " + msg;
}

/*** API calls (POST only) ***/
async function apiPost(action, payload){
  const body = { action, key: API_KEY, ...(payload || {}) };

  const res = await fetch(API_URL, {
    method:"POST",
    mode:"cors",
    credentials:"omit",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body),
    cache:"no-store",
    redirect:"follow",
  });

  const text = await res.text();
  console.log("POST raw response:", text);

  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error("Non-JSON from server"); }

  if (!data.ok) throw new Error(data.error || "Server error");
  return data;
}

async function apiGetAll(){
  return apiPost("getall", {});
}

/*** render ***/
function renderAll(){
  const tbody = $("tbody");
  tbody.innerHTML = "";

  const sorted = [...entries].sort((a,b)=>String(b.date||"").localeCompare(String(a.date||"")));

  for(const e of sorted){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.date||""}</td>
      <td>${e.collectedBy||""}</td>
      <td>${clamp0(e.eggs)}</td>
      <td>${clamp0(e.dozens)}</td>
      <td>${clamp0(e.packs18)}</td>
    `;
    tbody.appendChild(tr);
  }

  // delete dropdown
  const sel = $("deleteSelect");
  sel.innerHTML = "";
  const o0 = document.createElement("option");
  o0.value = "";
  o0.textContent = "Select an entry…";
  sel.appendChild(o0);

  for(const e of sorted){
    const opt = document.createElement("option");
    opt.value = e.id || e.date || "";
    opt.textContent = `${e.date||""} — ${e.collectedBy||""} — eggs:${clamp0(e.eggs)}`;
    sel.appendChild(opt);
  }

  // stats
  const today = isoToday();
  $("asOf").textContent = "as of " + new Date().toLocaleString();

  const w365 = daysWindow(today,365);
  const w30  = daysWindow(today,30);
  const w7   = daysWindow(today,7);

  let eggs365=0, daysWith=0;
  let rev7=0, rev30=0;

  // Prefer latest saved prices (if present)
  if(sorted[0]){
    settings.priceDozen = sorted[0].priceDozen ?? settings.priceDozen;
    settings.price18 = sorted[0].price18 ?? settings.price18;
    settings.hens = sorted[0].hens ?? settings.hens;
    settings.roosters = sorted[0].roosters ?? settings.roosters;
  }

  // Keep inputs in sync with remembered settings
  $("hens").value = settings.hens ?? $("hens").value;
  $("roosters").value = settings.roosters ?? $("roosters").value;
  $("priceDozen").value = settings.priceDozen ?? $("priceDozen").value;
  $("price18").value = settings.price18 ?? $("price18").value;

  for(const e of entries){
    if(!e.date) continue;
    const d = parseISO(String(e.date).slice(0,10));
    const eggs = clamp0(e.eggs);
    const dz = clamp0(e.dozens);
    const p18 = clamp0(e.packs18);

    if(inRange(d,w365.start,w365.end)){
      eggs365 += eggs;
      daysWith += 1;
    }
    if(inRange(d,w7.start,w7.end)){
      rev7 += dz * clamp0(settings.priceDozen) + p18 * clamp0(settings.price18);
    }
    if(inRange(d,w30.start,w30.end)){
      rev30 += dz * clamp0(settings.priceDozen) + p18 * clamp0(settings.price18);
    }
  }

  const denom = Math.max(1, daysWith);
  const daily = eggs365 / denom;

  $("eggs365").textContent = eggs365.toFixed(0);
  $("eggsWeek").textContent = (daily*7).toFixed(1);
  $("eggsMonth").textContent = (daily*30.4).toFixed(1);
  $("eggsYear").textContent = (daily*365).toFixed(0);
  $("rev7").textContent = fmtUSD(rev7);
  $("rev30").textContent = fmtUSD(rev30);
}

/*** actions ***/
async function syncNow(){
  try{
    setSync("", "syncing…");
    const data = await apiGetAll();

    entries = Array.isArray(data.entries) ? data.entries : [];
    renderAll();

    setSync("ok", "ok");
    setStatus("");
  }catch(err){
    setSync("err", "error");
    setStatus("Sync failed: " + (err?.message || err));
  }
}

async function saveDay(){
  try{
    setStatus("Saving…");

    const date = $("dateISO").value || isoToday();

    const entry = {
      id: date,
      date: date,
      collectedBy: $("collector").value || "Dylan",

      eggs: clamp0($("eggs").value),
      dozens: clamp0($("soldDozens").value),
      packs18: clamp0($("sold18").value),

      hens: clamp0($("hens").value),
      roosters: clamp0($("roosters").value),
      priceDozen: clamp0($("priceDozen").value),
      price18: clamp0($("price18").value),
    };

    await apiPost("upsert", { entry });

    setStatus("Saved ✅");
    $("eggs").value = "";
    $("soldDozens").value = "";
    $("sold18").value = "";

    await syncNow();
  }catch(err){
    setStatus("Save failed: " + (err?.message || err));
  }
}

async function deleteSelected(){
  const id = $("deleteSelect").value;
  if(!id) return alert("Pick an entry first.");
  if(!confirm("Delete entry " + id + " ?")) return;

  try{
    await apiPost("delete", { id });
    await syncNow();
  }catch(err){
    alert("Delete failed: " + (err?.message || err));
  }
}

async function wipeAll(){
  const typed = prompt('Type WIPE to delete ALL shared data:', '');
  if(typed !== "WIPE") return;

  try{
    await apiPost("wipeall", { confirm:"WIPE" });
    await syncNow();
  }catch(err){
    alert("Wipe failed: " + (err?.message || err));
  }
}

/*** wire UI ***/
$("dateISO").value = isoToday();
$("syncBtn").addEventListener("click", syncNow);
$("saveBtn").addEventListener("click", saveDay);
$("deleteBtn").addEventListener("click", deleteSelected);
$("wipeBtn").addEventListener("click", wipeAll);

// Auto sync on load + every 20s
syncNow();
setInterval(syncNow, 20000);
</script>

<script>
  // Optional cleanup: remove any old/broken service workers + caches
  (async () => {
    try {
      if ("serviceWorker" in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
      console.log("SW + caches cleared");
    } catch (e) {
      console.log("Cleanup error", e);
    }
  })();
</script>

</body>
</html>
